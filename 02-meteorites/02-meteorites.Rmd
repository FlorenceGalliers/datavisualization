---
title: "02-meteorites"
author: "Florence Galliers"
date: "17/01/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(dplyr)
library(ggplot2)
library(extrafont)
library(showtext)
#font_import()

library(maps)
library(countrycode)
library(devtools)
devtools::install_github('rensa/ggflags')
library(ggflags)
library(tidyr)
```

Meteorite Data Set contains information about where and when meteorites were found or fell. There is a difference between a 'found' meteorite and a 'fell' meteorite. Those that are classified as 'fell' are those which were seen falling from the sky and later tracked down successfully, whereas those which were 'found' do not have a exact date or location of their falling.

```{r}
meteorites <- readr::read_csv("https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2019/2019-06-11/meteorites.csv")

# start by summarising the count of meteorites per year
meteorites_total <- meteorites %>%
  group_by(year) %>%
  dplyr::summarise(Count = n())
# plot
plot(x = meteorites_total$year,
     y = meteorites_total$Count,
     type = "l")

# subset data for 1900 --> present
which.max(meteorites_total$year)
meteorites_total[265,] # this is the year 2101? in the future... 
meteorites_total <- meteorites_total[-265, ]
which.max(meteorites_total$year)
meteorites_total[264,] # the most recent is now 2013.

# subset data 1900-2013
meteorites_total <- meteorites_total %>%
  subset(year > 1900)
# plot again
plot(x = meteorites_total$year,
     y = meteorites_total$Count,
     type = "l")

# still not that much happening up until 1970 - lets subset again
meteorites_total <- meteorites_total %>%
  subset(year > 1970)
# plot again
plot(x = meteorites_total$year,
     y = meteorites_total$Count,
     type = "l")

# what about just fallen meteorites because those that were found may not have fallen in that year.
meteorites_total2 <- meteorites %>%
  filter(fall == "Fell") %>%
  group_by(year) %>%
  dplyr::summarise(Count = n())

plot(x = meteorites_total2$year,
     y = meteorites_total2$Count,
     type = "l")

# again not much going on until 1750? so lets subset down
meteorites_total2 <- meteorites_total2 %>%
  subset(year > 1750)

plot(x = meteorites_total2$year,
     y = meteorites_total2$Count,
     type = "l",
     col = "black",
     lwd = 2)

# group by decade
meteorites3 <- meteorites %>% 
  mutate(decade = year - year%%10) %>% 
  filter(decade>=1750, decade<=2005) %>% 
  select(name,mass,fall, year,decade, lat,long) %>% 
  drop_na()

# filter again to just fallen meteorites
meteorites_total3 <- meteorites3 %>%
  filter(fall == "Fell") %>%
  group_by(decade) %>%
  dplyr::summarise(Count = n())

```

```{r}
# Downloaded title font from (https://www.dafont.com/galaxy-1.font?text=The+Rise+and+Fall+of+Meteorites)

subtitle <- "Fallen meteorites are those that were spotted falling and later tracked, the number\nof these found worldwide per decade is shown here"


# plot
par(bg = "white", xpd = NA)

plot(x = meteorites_total3$decade,
     y = meteorites_total3$Count,
     type = "l",
     col = "grey30",
     lwd = 4,
     xlab = "",
     ylab = "",
     bty = "n",
     xaxt = "none", yaxt = "none",
     cex.lab = 0.8, 
     col.lab = "grey50")

# add title
title("The Rise and Fall of Meteorites",
      family = "Galaxy 1", 
      cex.main = 3,
      col.main = "grey20")

# add y axis title
title(ylab = "Number of meteorites",
      line = 2, 
      col.lab = "grey50",
      cex.lab = 0.8)

# add subtitle
text(1827,90, subtitle,
     col = "grey30")

# add points
points(x = meteorites_total3$decade,
       y = meteorites_total3$Count,
       pch = 8, 
       cex = 1.5,
       col = "#FADA5E")
# x axis
axis(1, labels = F,
     col = "grey40",
     col.axis = "grey40",
     tck = F)

text(x = seq(1750, 2000, 10),
     y = par("usr")[3] - 1,
     labels = meteorites_total3$decade,
     xpd = NA, srt = 35,
     adj = 1, cex = 0.8,
     col = "grey40")

# y axis
axis(2, seq(0, 90, 10),
     las = 2,
     col = "grey40",
     col.axis = "grey40",
     cex.axis = 0.8,
     tck = -0.01)

```

Now for a plot using ggplot

```{r}

meteorites_ordered <- meteorites[order(-meteorites$mass), ]

# find the top say 20 largest? and subset
top20 <- meteorites_ordered[1:20,]
# Convert mass from g to kg
top20$mass <- (top20$mass/1000)
# convert mass from kg to tonnes
top20$mass <- (top20$mass/1000)


ggplot(top20,
       aes(x = reorder(name, mass),
           y = mass,
           fill = class)) +
  geom_bar(stat = "identity") +
  coord_flip() +
  labs(y = "Mass (tonnes)",
       x = "")

# get the countries for each of these top 20 meteorites.
country <- map.where(database = "world",
                     top20$long, 
                     top20$lat)

country # entry 2 and 16 are NAs

top20$geolocation[2] # Greenland
country[2] <- "Greenland"
top20$geolocation[16] # Brazil
country[16] <- "Brazil"

# use country code to convert country name into iso2 code ready to use with ggflag
country_code <- countrycode(country, 
            "country.name",
            "iso2c")

country_code <- tolower(country_code)

# bind country code with top 20 
top20c <- cbind(top20, country_code)

# combine some classes
top20c$class <- factor(top20c$class)
levels(top20c$class)
levels(top20c$class) <- c("Stony Chondrites",
                          "Metallic (Iron)",
                          "Metallic (Iron)",
                          "Metallic (Iron)",
                          "Metallic (Iron)",
                          "Metallic (Iron)",
                          "Metallic (Iron)",
                          "Metallic (Iron)",
                          "Metallic (Iron)",
                          "Metallic (Iron)",
                          "Metallic (Iron)",
                          "Stony-Iron",
                          "Stony-Iron")
top20c$class <- factor(top20c$class, levels = c("Metallic (Iron)", "Stony-Iron", "Stony Chondrites")) 

# create new column combining name of meteorite and year it fell
top20c$title <- paste(top20c[ , 1],",", top20c[ , 7])

# now replot including flags
ggplot(top20c,
       aes(x = reorder(title, mass), y = mass,
           fill = class)) +
  geom_segment(aes(x = reorder(title, mass), xend = title, 
                   y = 0, yend = mass,
                   color = class),
               size = 3, alpha = 0.2) +
    geom_segment(aes(x = reorder(title, mass), xend = title, 
                   y = 0, yend = mass,
                   color = class),
               size = 1, alpha = 0.8) +
  geom_flag(aes(x = reorder(title, mass), y = 0, 
                country = country_code), 
            size = 6) + 
  geom_label(label = round(top20$mass, 0),
    nudge_y = 1,
    colour = "white",
    family = "Avenir",
    show.legend = F
  ) +
  geom_label(label = "Mass in tonnes",
             x = 8.5, y = 48,
             colour = "white",
             fill = "grey60",
             family = "Avenir") +
  scale_color_manual(values = c("#8B8682", "coral", "#ffcc00")) +
  scale_fill_manual(values = c("#8B8682",  "coral", "#ffcc00")) +
  coord_flip(clip = "off") +
  labs(title = "Name, Year found ---------------- Country",
       y = "Mass (tonnes)",
       x = "") +
  theme_minimal() +
  theme(
    axis.text.y = element_text(hjust = 0,
                               colour = "#615d5b",
                               family = "Avenir",
                               size = 10),
    plot.background = element_rect(fill = "white"
                                     #"#003f5c"
                                   ),
    plot.title = element_text(colour = "#8B8682",
                              family = "Avenir",
                              size = 8,
                              vjust = 0,
                              hjust = 0),
    panel.grid = element_blank(),
    legend.title = element_blank(),
    legend.position = c(0.77, 0.33),
    axis.title.x = element_text(colour = "#615d5b",
                                family = "Avenir",
                                size = 10),
    axis.text.x = element_text(colour = "#615d5b",
                               family = "Avenir",
                               size = 10),
    axis.line.x = element_line(colour = "#615d5b")
  ) +
  annotate("text",
           x = 12, 
           y = 48, 
           label = "IRON METEORITES ARE THE\n LARGEST TO BE FOUND",
           color = "#615d5b",
           family = "Avenir",
           size = 7) +
  annotate("text",
           x = 10, 
           y = 48,
           label = "18 out of 20 of the largest meteorites\nto found on Earth were made of Iron",
           colour = "#8B8682",
           family = "Avenir",
           size = 4) 
```

Interactive plot: where are the meteorites in the world?

```{r}

```

