---
title: "03-malaria"
author: "Florence Galliers"
date: "17/01/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(ggplot2)
library(viridis)
library(rnaturalearth)
library(countrycode)
library(GGally)
library(doBy)

```

Malaria. 1990 to 2016.

Three datasets are used to create these visualizations. They come from ‘Our World in Data’ and contain information about malaria incidence and deaths in every country worldwide.

```{r}
# Get data
tuesdata <- tidytuesdayR::tt_load('2018-11-13')
malaria_deaths_age <- tuesdata$malaria_deaths_age
malaria_deaths <- tuesdata$malaria_deaths
malaria_inc <- tuesdata$malaria_inc


# Explore the datasets
head(malaria_deaths_age)
# 6 columns
# X1, entity = country, code, year, age group and number of deaths
# There are 30780 observations

# How many countries?
unique(malaria_deaths_age$code) # 197
unique(malaria_deaths_age$entity) #228
unique(malaria_deaths_age$age_group)
# this should be a factor?
malaria_deaths_age$age_group <- factor(malaria_deaths_age$age_group, 
                                       levels = c("Under 5",
                                                  "5-14",
                                                  "15-49",
                                                  "50-69",
                                                  "70 or older"))

unique(malaria_deaths_age$year)
# year goes from 1990 to 2016

# make line plot of malaria deaths by year
world_malaria_deaths <- malaria_deaths %>%
  subset(Entity == "World")

world_malaria_deaths$deaths <- world_malaria_deaths$`Deaths - Malaria - Sex: Both - Age: Age-standardized (Rate) (per 100,000 people)`

plot(x = world_malaria_deaths$Year,
     y = world_malaria_deaths$deaths,
     type = "l",
     ylim = c(10, 180))

# How many deaths are from Niger? the country with the most deaths
niger_deaths <- malaria_deaths %>%
  subset(Entity == "Niger")

niger_deaths$deaths <- niger_deaths$`Deaths - Malaria - Sex: Both - Age: Age-standardized (Rate) (per 100,000 people)`

lines(x = niger_deaths$Year,
      y = niger_deaths$deaths,
      type = "l")

# the world malaria deaths are the average, not the total.

# Look at incidence. 2000, 2005, 2010, 2015
# Parallel plot of African countries over time

head(malaria_inc)
# contains incidence data as a rate, per 1,000 of population at risk.

# Extract just countries in continent of Africa from this?
malaria_inc$continent <- countrycode(malaria_inc$Entity, 
            "country.name",
            "continent")

africa_inc <- malaria_inc %>%
  subset(continent == "Africa")

head(africa_inc)

# change format to wide (not tidy!) so it can be used to make a parallel plot
africa_inc_wide <- africa_inc %>%
  pivot_wider(names_from = "Year",
              values_from = "Incidence of malaria (per 1,000 population at risk) (per 1,000 population at risk)")

head(africa_inc_wide)

# calculate difference between 2015 and 2000 incidence rates
africa_inc_wide$diff <- (africa_inc_wide$`2000`-africa_inc_wide$`2015`)

# create new column to colour plot by, if difference in rate is larger than 300
africa_inc_wide$class <- ifelse((africa_inc_wide$diff > 300), 1, 0)

# which rates are the highest?
which.maxn(africa_inc_wide$`2015`, n = 3)
# change these to class 2
africa_inc_wide[c(28, 5, 33), 9] <- 2

# increased rates in 2015
africa_inc_wide$diff2 <- (africa_inc_wide$`2010`-africa_inc_wide$`2015`)
africa_inc_wide[which.min(africa_inc_wide$diff2), 9] <- 3

africa_inc_wide$class <- as.factor(africa_inc_wide$class)

africa_inc_subset <- africa_inc_wide %>%
  subset(class != 0)

# parallel plot
africa_inc_wide %>%
  ggparcoord(
    columns = 4:7,
    groupColumn = "class",
    title = "Malaria Incidence Rate in African Countries",
    scale = "globalminmax",
    alphaLines = 1
    ) +
  labs(y = "Incidence per 1,000 people") +
  scale_color_manual(values = c("grey80", "#3b990f", "#9a4c94", "#0077c7")) +
  theme_minimal() +
  theme(
    legend.position = "none",
    plot.title = element_text(size = 16,
                              family = "Avenir"),
    axis.title.x = element_blank(),
    axis.title.y = element_text(size = 8, 
                                family = "Avenir"),
    panel.grid = element_blank()
  ) +
  scale_x_discrete(expand = c(0.1, 0.1))

# try this without ggparcoord, just ggplot
africa_inc <- africa_inc %>%
  rename(
    incidence = 'Incidence of malaria (per 1,000 population at risk) (per 1,000 population at risk)')

```

Deaths in Mali

We have seen that the malaria incidence in Mali is the highest out of all African countries. What about deaths in Mali?

```{r}
head(malaria_deaths_age)

mali_deaths <- malaria_deaths_age %>%
  subset(code == "MLI")

mali_2016 <- mali_deaths %>%
  subset(year == 2016)

mali_2016 <- mali_2016[, 5:6]

mali_2016$age_group <- as.factor(mali_2016$age_group)

barplot(mali_2016$deaths)



```

Leaflet map of incidence and deaths in Africa
- slider to select year
- coloured by severity of malaria incidence and deaths - bivariate? 
- or just deaths..
- chloropleth map
- mouse over information pop up
- label top 10 most effected countries to make them stand out

```{r}
library(leaflet)
library(sf)
library(raster)
library(dplyr)
library(spData)
library(countrycode)

malaria_deaths_2016 <- malaria_deaths %>%
  filter(Year == 2016)

malaria_deaths_2016$deaths <- malaria_deaths_2016$`Deaths - Malaria - Sex: Both - Age: Age-standardized (Rate) (per 100,000 people)`

malaria_deaths_2016$iso_a2 <- countrycode(malaria_deaths_2016$Code, "iso3c", "iso2c") 

africa <- world %>% 
  filter(continent == "Africa") %>% 
  filter(iso_a2 != "EH") %>% #remove easter sahara as NA values
  left_join(malaria_deaths_2016, by = "iso_a2") %>% 
  dplyr::select(Entity, Year, deaths) %>% 
  st_transform("+proj=aea +lat_1=20 +lat_2=-23 +lat_0=0 +lon_0=25")

range(africa$deaths) # range of deaths in 2016 is 0 to 135.

# create bins for colour palette
bins <- c(0, 20, 40, 60, 80, 100, 120, 140)
# create palette
palette <- colorBin("YlOrRd", domain = africa$deaths, bins = bins)

# create labels
labels <- 

leaflet() %>% 
  addTiles() %>% 
  addPolygons(data = st_transform(africa, 4326),
              fillColor = ~palette(deaths),
              weight = 2,
              color = "white", 
              fillOpacity = 1)



```

