---
title: "03-malaria"
author: "Florence Galliers"
date: "17/01/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(ggplot2)
library(viridis)
library(rnaturalearth)
library(countrycode)

```

Malaria. 1990 to 2016.

Three datasets are used to create these visualizations. They come from ‘Our World in Data’ and contain information about malaria incidence and deaths in every country worldwide.

```{r}
# Get data
tuesdata <- tidytuesdayR::tt_load('2018-11-13')
malaria_deaths_age <- tuesdata$malaria_deaths_age
malaria_deaths <- tuesdata$malaria_deaths
malaria_inc <- tuesdata$malaria_inc

# Explore the datasets
head(malaria_deaths_age)
# 6 columns
# X1, entity = country, code, year, age group and number of deaths
# There are 30780 observations

# How many countries?
unique(malaria_deaths_age$code) # 197
unique(malaria_deaths_age$entity) #228
unique(malaria_deaths_age$age_group)
# this should be a factor?
malaria_deaths_age$age_group <- factor(malaria_deaths_age$age_group, 
                                       levels = c("Under 5",
                                                  "5-14",
                                                  "15-49",
                                                  "50-69",
                                                  "70 or older"))

unique(malaria_deaths_age$year)
# year goes from 1990 to 2016

# make line plot of malaria deaths by year
world_malaria_deaths <- malaria_deaths %>%
  subset(Entity == "World")

world_malaria_deaths$deaths <- world_malaria_deaths$`Deaths - Malaria - Sex: Both - Age: Age-standardized (Rate) (per 100,000 people)`

plot(x = world_malaria_deaths$Year,
     y = world_malaria_deaths$deaths,
     type = "l",
     ylim = c(10, 180))

# How many deaths are from Niger? the country with the most deaths
niger_deaths <- malaria_deaths %>%
  subset(Entity == "Niger")

niger_deaths$deaths <- niger_deaths$`Deaths - Malaria - Sex: Both - Age: Age-standardized (Rate) (per 100,000 people)`

lines(x = niger_deaths$Year,
      y = niger_deaths$deaths,
      type = "l")

# the world malaria deaths are the average, not the total.

```

Leaflet World Map

```{r}
library(leaflet)
library(maps)

# subset incidence data to just 2015
inc_2015 <- malaria_inc %>%
  subset(Year == "2015")

inc_2015$incidence <- inc_2015$`Incidence of malaria (per 1,000 population at risk) (per 1,000 population at risk)`

# get world countries data
world <- ne_countries(scale = "medium",
                      returnclass = "sf")

mypalette <- colorNumeric(palette = "viridis", 
                          domain = inc_2015$incidence,
                          na.color = "transparent")

mypalette(c(45, 43))

leafletmap <- leaflet(world) %>%
  addTiles() %>%
  setView(lat = 10, lng = 0, zoom = 2)

world_countries <- map("world", fill = TRUE)

leafletmap %>%
  addPolygons(fillColor = ~mypalette(inc_2015$incidence), stroke = FALSE)


```


ggplot

The dataset malaria_deaths_age shows how many people in each age group died from malaria in each country around the world.

Facet plot the deaths by age category for high, middle and low Socio-Demographic Index.

```{r}
# create new data frame containing only information for high, middle and low SDI

malaria_sdi <- malaria_deaths_age %>%
  subset(entity == "High SDI" | 
           entity == "Middle SDI" |
           entity == "Low SDI" |
           entity == "Low-middle SDI" |
           entity == "High-middle SDI")

# plot
ggplot(malaria_sdi,
       aes(x = year,
           y = deaths,
           fill = age_group)) +
  geom_area() +
  facet_grid(. ~ entity)

# there are no / minimal deaths in high, high-middle and middle SDI countries. Lets just do low and low-middle SDI.

malaria_sdi2 <- malaria_deaths_age %>%
  subset(entity == "Low SDI" |
           entity == "Low-middle SDI")

# relevel age groups so they are in age order.

malaria_sdi2$age_group <- factor(malaria_sdi2$age_group,
                                 levels = c("Under 5",
                                            "5-14",
                                            "15-49",
                                            "50-69",
                                            "70 or older"))
# reverse order of levels so 5 and under appears on the bottom of the graph.
malaria_sdi2$age_group <- factor(malaria_sdi2$age_group, 
                                 levels = rev(levels(malaria_sdi2$age_group)))

ggplot(malaria_sdi2,
       aes(x = year,
           y = deaths,
           fill = age_group)) +
  geom_area() +
  facet_grid(. ~ entity)





```
