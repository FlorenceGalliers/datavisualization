---
title: "03-malaria"
author: "Florence Galliers"
date: "17/01/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(dplyr)
library(ggplot2)
library(viridis)
library(rnaturalearth)
library(countrycode)
library(GGally)
library(doBy)
library(ggrepel)

```

Malaria. 1990 to 2016.

Three datasets are used to create these visualizations. They come from ‘Our World in Data’ and contain information about malaria incidence and deaths in every country worldwide.

```{r}
# Get data
tuesdata <- tidytuesdayR::tt_load('2018-11-13')
malaria_deaths_age <- tuesdata$malaria_deaths_age
malaria_deaths <- tuesdata$malaria_deaths
malaria_inc <- tuesdata$malaria_inc


# Explore the datasets
head(malaria_deaths_age)
# 6 columns
# X1, entity = country, code, year, age group and number of deaths
# There are 30780 observations

# How many countries?
unique(malaria_deaths_age$code) # 197
unique(malaria_deaths_age$entity) #228
unique(malaria_deaths_age$age_group)
# this should be a factor?
malaria_deaths_age$age_group <- factor(malaria_deaths_age$age_group, 
                                       levels = c("Under 5",
                                                  "5-14",
                                                  "15-49",
                                                  "50-69",
                                                  "70 or older"))

unique(malaria_deaths_age$year)
# year goes from 1990 to 2016

# make line plot of malaria deaths by year
world_malaria_deaths <- malaria_deaths %>%
  subset(Entity == "World")

world_malaria_deaths$deaths <- world_malaria_deaths$`Deaths - Malaria - Sex: Both - Age: Age-standardized (Rate) (per 100,000 people)`

plot(x = world_malaria_deaths$Year,
     y = world_malaria_deaths$deaths,
     type = "l",
     ylim = c(10, 180))

# How many deaths are from Niger? the country with the most deaths
niger_deaths <- malaria_deaths %>%
  subset(Entity == "Niger")

niger_deaths$deaths <- niger_deaths$`Deaths - Malaria - Sex: Both - Age: Age-standardized (Rate) (per 100,000 people)`

lines(x = niger_deaths$Year,
      y = niger_deaths$deaths,
      type = "l")

# the world malaria deaths are the average, not the total.

# Look at incidence. 2000, 2005, 2010, 2015
# Parallel plot of African countries over time

head(malaria_inc)
# contains incidence data as a rate, per 1,000 of population at risk.

# Extract just countries in continent of Africa from this?
malaria_inc$continent <- countrycode(malaria_inc$Entity, 
            "country.name",
            "continent")

africa_inc <- malaria_inc %>%
  subset(continent == "Africa")

head(africa_inc)
africa_inc <- africa_inc %>%
  rename(incidence = 'Incidence of malaria (per 1,000 population at risk) (per 1,000 population at risk)')

africa_inc_high <- africa_inc %>%
  filter(Entity == "Mali" | Entity == "Burkina Faso" | Entity == "Nigeria")

africa_inc_low <- africa_inc %>%
  filter(Entity == "Ethiopia" | Entity == "Guinea-Bissau" | Entity == "Sao Tome and Principe")


ggplot(africa_inc, aes(x = Year, 
                       y = incidence,
                       group = Entity)) +
  geom_line(color = "grey90") +
  geom_line(data = africa_inc_high, color = "#C12910",
            size = 1) +
  geom_line(data = africa_inc_low, color = "#2A9D8F",
            size = 1) +
  coord_trans(clip = "off") +
  theme_minimal() +
  geom_text(data = subset(africa_inc_high, Year == 2010), 
            aes(label = Entity, y = incidence + 15),
            color = "#C12910",
            hjust = 0.5,
            x = 2010,
            family = "Futura Medium") +
  geom_text(data = subset(africa_inc_low, Year == 2015), 
            aes(label = Entity, y = incidence-10),
            color = "#2A9D8F", 
            x = 2015,
            family = "Futura Medium") +
  labs(title = "There is a still vast disparity in Malaria incidence rates throughout Africa",
       y = "Incidence Rate (per 1,000 people)") +
  theme(
    panel.grid = element_blank(),
    plot.title = element_text(
      family = "Futura Medium",
      size = 16
    ),
    axis.title = element_text(
      family = "Futura Medium",
      size = 9,
      hjust = 0.5
    ),
    axis.text = element_text(
      family = "Futura Medium",
      size = 10),
    
    ) 


# subset death data for africa

malaria_deaths$continent <- countrycode(malaria_deaths$Entity, 
            "country.name",
            "continent")

africa_deaths <- malaria_deaths %>%
  subset(continent == "Africa") %>%
  filter(Year == 2015)

head(africa_deaths)
africa_deaths <- africa_deaths %>%
  rename(deaths = `Deaths - Malaria - Sex: Both - Age: Age-standardized (Rate) (per 100,000 people)`)

africa_total <- merge(africa_inc, africa_deaths,
                      by.x = "Entity",
                      by.y = "Entity",
                      all.x = T) %>%
  dplyr::select(Entity, Year.x, incidence, deaths) %>%
  rename("year" = "Year.x")

africa_total_high <- africa_total %>%
  filter(Entity == "Mali" | Entity == "Burkina Faso" | Entity == "Nigeria")

africa_total_low <- africa_total %>%
  filter(Entity == "Ethiopia" | Entity == "Guinea-Bissau" | Entity == "Sao Tome and Principe")

africa_total_low$Entity <- gsub("Sao Tome and Principe", "Sao Tome\nand Principe", africa_total_low$Entity)


africa_total_low


# plot and make line widths show the number of deaths
ggplot(africa_total, aes(x = year, 
                       y = incidence,
                       group = Entity, 
                       size = deaths)) +
  geom_line(color = "grey90",
            alpha = 0.6) +
  geom_line(data = africa_total_high, color = c("#C12910","#C12910","#C12910","#C12910",
                                                "#980000", "#980000", "#980000", "#980000",
                                                "#FB5E3C", "#FB5E3C", "#FB5E3C", "#FB5E3C"),
            aes(size = deaths), alpha = 0.6) +
  geom_line(data = africa_total_low, color = c("#2A9D8F", "#2A9D8F", "#2A9D8F", "#2A9D8F",
                                               "#007362", "#007362", "#007362", "#007362",
                                               "#64CFBF", "#64CFBF", "#64CFBF", "#64CFBF"),
            aes(size = deaths), alpha = 0.6) +
  coord_trans(clip = "off") +
  theme_minimal() +
  geom_text(data = subset(africa_total_high, year == 2015), 
            aes(label = Entity, y = incidence),
            color = c("#C12910", "#980000", "#FB5E3C"),
            hjust = 0,
            x = 2015.1,
            family = "Futura Medium",
            size = 4) +
  geom_text(data = subset(africa_total_low, year == 2015), 
            aes(label = Entity, y = incidence),
            color = c("#2A9D8F", "#007362", "#64CFBF"), 
            hjust = 0,
            x = 2015.1,
            family = "Futura Medium",
            size = 4) +
  labs(title = "There is a still vast disparity in Malaria incidence and death rates throughout Africa",
       y = "Incidence Rate (per 1,000 people)") +
  theme(
    panel.grid = element_blank(),
    plot.title = element_text(
      family = "Futura Medium",
      size = 16
    ),
    axis.title = element_text(
      family = "Futura Medium",
      size = 9,
      hjust = 0.5
    ),
    axis.text = element_text(
      family = "Futura Medium",
      size = 10),
    legend.position = c(0.9, 0.9),
    plot.margin = unit(c(1,2,1,1), "cm")
    
    ) 

```

Deaths in Mali

We have seen that the malaria incidence in Mali is the highest out of all African countries. What about deaths in Mali?

```{r}
head(malaria_deaths_age)

mali_deaths <- malaria_deaths_age %>%
  subset(code == "MLI") %>%
  dplyr::select(year, age_group, deaths)

plot(x = mali_deaths$year,
     y = mali_deaths$deaths)
polygon(x = mali_deaths$year,
     y = mali_deaths$deaths)

mali_deaths$age_group <- factor(mali_deaths$age_group, 
                                       levels = c("Under 5",
                                                  "5-14",
                                                  "15-49",
                                                  "50-69",
                                                  "70 or older"))

mali_deaths_wise <- mali_deaths %>%
  pivot_wider(names_from = year,
              values_from = deaths)

mali_deaths_wise <- as.data.frame(mali_deaths_wise)

rownames(mali_deaths_wise) <- c("Under 5", "70+", "5-14", "15-49", "50-69")
mali_deaths_wise <- mali_deaths_wise[, -1]

barplot(mali_deaths_wise)



```

